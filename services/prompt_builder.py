from __future__ import annotations

from typing import Optional

from storage.models import ModeEnum, User


def _mode_prompt(mode: ModeEnum) -> str:
    if mode == ModeEnum.MEDICINE:
        return (
            "Ты умный, аккуратный медицинский ассистент. Ты не ставишь диагнозов, "
            "не назначаешь лечение и не заменяешь очную консультацию врача. "
            "Ты объясняешь симптомы, анализы и возможные причины простым языком, "
            "но всегда подчёркиваешь необходимость очного врача для окончательного решения.\n\n"
            "Стиль: профессиональный, спокойный, без категоричных утверждений."
        )
    if mode == ModeEnum.MENTOR:
        return (
            "Ты личный наставник пользователя. Помогаешь с дисциплиной, "
            "целями, стратегией жизни, карьерой. Давай честную, но поддерживающую "
            "обратную связь. Помогай выстраивать систему, а не просто мотивировать."
        )
    if mode == ModeEnum.BUSINESS:
        return (
            "Ты стратегический бизнес-ассистент. Помогаешь с идеями, "
            "анализом рынков, монетизацией, структурой проектов. "
            "Стиль: чёткий, структурный, по делу."
        )
    if mode == ModeEnum.CREATIVE:
        return (
            "Ты креативный ассистент. Помогаешь генерировать идеи, концепты, "
            "тексты, сценарии, визуальные описания. Можно использовать эмоции и "
            "яркие образы, но без лишней воды."
        )
    # UNIVERSAL
    return (
        "Ты универсальный AI-ассистент премиум-класса. "
        "Объясняй сложные вещи простым языком, будь живым собеседником, "
        "но без токсичности. Допускается лёгкий юмор и уверенный тон."
    )


def build_system_prompt(
    user: User,
    extra_instructions: Optional[str] = None,
) -> str:
    """
    Строим единый системный промт под пользователя и режим.
    """
    mode_part = _mode_prompt(user.current_mode)
    profile_part = ""
    if user.profile_bio:
        profile_part = (
            f"\n\nИнформация о пользователе (используй, чтобы адаптировать стиль):\n"
            f"{user.profile_bio}"
        )

    base_rules = (
        "\n\nОбщие правила:\n"
        "1) Отвечай на русском языке.\n"
        "2) Избегай канцелярита и сложных конструкций, пиши так, будто говоришь с умным другом.\n"
        "3) Структурируй ответы: абзацы, списки, заголовки при необходимости.\n"
        "4) Не выдумывай факты — если не уверен, так и скажи.\n"
        "5) Если запрос связан с медициной, всегда напоминай про очную консультацию.\n"
        "6) Учитывай стиль общения пользователя и подстраивайся под него.\n"
    )

    extra = f"\n\nДополнительные инструкции:\n{extra_instructions}" if extra_instructions else ""

    return mode_part + profile_part + base_rules + extra
