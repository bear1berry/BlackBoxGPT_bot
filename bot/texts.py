# bot/texts.py
from __future__ import annotations
from typing import Optional
from datetime import datetime

from .models import User

MODE_TITLES = {
    "universal": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π",
    "medicine": "–ú–µ–¥–∏—Ü–∏–Ω–∞",
    "mentor": "–ù–∞—Å—Ç–∞–≤–Ω–∏–∫",
    "business": "–ë–∏–∑–Ω–µ—Å",
    "creative": "–ö—Ä–µ–∞—Ç–∏–≤",
}


def build_onboarding_text(name: Optional[str]) -> str:
    display_name = name or "–¥—Ä—É–≥"

    return (
        f"üëã –ü—Ä–∏–≤–µ—Ç, <b>{display_name}</b>!\n\n"
        "–Ø <b>BlackBox GPT</b> ‚Äî —Ç–≤–æ–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n"
        "–ú–∏–Ω–∏–º–∞–ª–∏–∑–º, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.\n\n"
        "–ß—Ç–æ —è –º–æ–≥—É –¥–ª—è —Ç–µ–±—è –¥–µ–ª–∞—Ç—å:\n"
        "‚Ä¢ üß† <b>–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π</b> ‚Äî –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–¥–∞—á–∏.\n"
        "‚Ä¢ ü©∫ <b>–ú–µ–¥–∏—Ü–∏–Ω–∞</b> ‚Äî —Ä–∞–∑–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–æ –Ω–µ –≤–º–µ—Å—Ç–æ –≤—Ä–∞—á–∞.\n"
        "‚Ä¢ üî• <b>–ù–∞—Å—Ç–∞–≤–Ω–∏–∫</b> ‚Äî –º–æ—Ç–∏–≤–∞—Ü–∏—è, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–æ—Å—Ç.\n"
        "‚Ä¢ üíº <b>–ë–∏–∑–Ω–µ—Å</b> ‚Äî –∏–¥–µ–∏, –≤–æ—Ä–æ–Ω–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Ç–µ–∫—Å—Ç—ã.\n"
        "‚Ä¢ üé® <b>–ö—Ä–µ–∞—Ç–∏–≤</b> ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è, –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–∑—ã.\n\n"
        "–í–Ω–∏–∑—É —Ç—ã –≤–∏–¥–∏—à—å –º–æ–π —Ç–∞—Å–∫–±–∞—Ä.\n"
        "–ù–∞—á–Ω–∏ —Å –∫–Ω–æ–ø–∫–∏ <b>üß† –†–µ–∂–∏–º—ã</b>, –≤—ã–±–µ—Ä–∏, –∫–∞–∫ —è –±—É–¥—É –¥—É–º–∞—Ç—å –¥–ª—è —Ç–µ–±—è ‚Äî "
        "–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å."
    )


def build_main_menu_text(user: User) -> str:
    mode_title = MODE_TITLES.get(user.current_mode, "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π")
    status = "üíé Premium" if user.is_premium else "Free"
    premium_until = (
        user.premium_until.strftime("%d.%m.%Y")
        if user.is_premium and user.premium_until
        else "‚Äî"
    )

    return (
        "üß© <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
        f"–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: <b>{mode_title}</b>\n"
        f"–°—Ç–∞—Ç—É—Å: <b>{status}</b>\n"
        f"Premium –¥–æ: <b>{premium_until}</b>\n\n"
        "‚¨áÔ∏è –í–Ω–∏–∑—É ‚Äî —Ç–≤–æ–π —Ç–∞—Å–∫–±–∞—Ä:\n"
        "‚Ä¢ üß† –†–µ–∂–∏–º—ã ‚Äî –∫–∞–∫ —è –¥—É–º–∞—é.\n"
        "‚Ä¢ üë§ –ü—Ä–æ—Ñ–∏–ª—å ‚Äî —Å—Ç–∞—Ç—É—Å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞.\n"
        "‚Ä¢ üíé –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –æ—Ñ–æ—Ä–º–∏—Ç—å / –ø—Ä–æ–¥–ª–∏—Ç—å Premium.\n"
        "‚Ä¢ üë• –†–µ—Ñ–µ—Ä–∞–ª—ã ‚Äî —Ç–≤–æ—è —Å—Å—ã–ª–∫–∞ –∏ –±–æ–Ω—É—Å—ã.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –∏ —è –æ—Ç–≤–µ—á—É –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ."
    )


def build_profile_text(user: User, referral_link: str) -> str:
    mode_title = MODE_TITLES.get(user.current_mode, "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π")
    status = "üíé Premium" if user.is_premium else "Free"
    premium_until = (
        user.premium_until.strftime("%d.%m.%Y")
        if user.is_premium and user.premium_until
        else "‚Äî"
    )

    return (
        "üë§ <b>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n"
        f"ID: <code>{user.tg_id}</code>\n"
        f"–ò–º—è: <b>{user.first_name or ''} {user.last_name or ''}</b>\n"
        f"–ù–∏–∫: @{user.username if user.username else '‚Äî'}\n\n"
        f"–†–µ–∂–∏–º: <b>{mode_title}</b>\n"
        f"–°—Ç–∞—Ç—É—Å: <b>{status}</b>\n"
        f"Premium –¥–æ: <b>{premium_until}</b>\n\n"
        "üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n"
        "–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π ‚Äî –ø–æ–ª—É—á–∞–π Premium-–¥–Ω–∏ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n"
        f"üìé –¢–≤–æ—è —Å—Å—ã–ª–∫–∞:\n<code>{referral_link}</code>"
    )


def build_subscription_text() -> str:
    return (
        "üíé <b>–ü–æ–¥–ø–∏—Å–∫–∞ BlackBox GPT</b>\n\n"
        "Premium –¥–∞—ë—Ç —Ç–µ–±–µ:\n"
        "‚Ä¢ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ Perplexity;\n"
        "‚Ä¢ –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏;\n"
        "‚Ä¢ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ –æ—á–µ—Ä–µ–¥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n\n"
        "–ü–ª–∞–Ω—ã (–æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Crypto Bot):\n"
        "‚Ä¢ üíé 1 –º–µ—Å—è—Ü ‚Äî 7.99$;\n"
        "‚Ä¢ üíé 3 –º–µ—Å—è—Ü–∞ ‚Äî 25.99$;\n"
        "‚Ä¢ üíé 12 –º–µ—Å—è—Ü–µ–≤ ‚Äî 89.99$.\n\n"
        "–í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π –ø–ª–∞–Ω –≤ –º–µ–Ω—é –Ω–∏–∂–µ ‚Äî –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –∏ —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏—é."
    )


def build_referrals_text(referral_link: str, bonus_days: int) -> str:
    return (
        "üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\n"
        f"–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ñ–æ—Ä–º–∏—Ç Premium –ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ, "
        f"—Ç—ã –ø–æ–ª—É—á–∞–µ—à—å <b>{bonus_days}</b> –¥–Ω–µ–π Premium.\n\n"
        "üìé –¢–≤–æ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n"
        f"<code>{referral_link}</code>\n\n"
        "–ü–æ–¥–µ–ª–∏—Å—å –µ—é –≤ —Å–≤–æ–∏—Ö —á–∞—Ç–∞—Ö, –∫–∞–Ω–∞–ª–∞—Ö –∏–ª–∏ —Å–æ—Ü—Å–µ—Ç—è—Ö."
    )


def format_llm_answer(raw_text: str) -> str:
    """
    –õ—ë–≥–∫–∞—è –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏:
    ‚Äî —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã,
    ‚Äî —Å–ª–µ–¥–∏–º –∑–∞ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.
    """
    lines = [line.rstrip() for line in raw_text.splitlines()]
    while lines and not lines[0]:
        lines.pop(0)
    while lines and not lines[-1]:
        lines.pop()
    return "\n".join(lines)
